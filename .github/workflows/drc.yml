name: DRC

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

jobs:
  drc:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          curl -L -o /tmp/requirements.txt https://github.com/IHP-GmbH/IHP-Open-PDK/raw/dev/requirements.txt
          pip install -r /tmp/requirements.txt

      - name: Install KLayout (current)
        run: |
          set -euo pipefail
          KLAYOUT_URL=$(curl -fsSL https://www.klayout.de/build.html | python - <<'PY'
          import re
          import sys

          html = sys.stdin.read()
          match = re.search(r'href="(https?://[^"]*klayout[^"]*\\.AppImage)"', html, re.IGNORECASE)
          if not match:
              raise SystemExit("Could not find KLayout AppImage URL on build.html")
          print(match.group(1))
          PY
          )
          echo "KLAYOUT_URL=$KLAYOUT_URL"
          curl -L -o /tmp/klayout "$KLAYOUT_URL"
          chmod +x /tmp/klayout
          echo "/tmp" >> "$GITHUB_PATH"

      - name: Locate latest release GDS
        id: gds
        run: |
          set -euo pipefail
          latest_dir=$(ls -d release/v.* | sort -V | tail -n 1)
          if [ -z "$latest_dir" ]; then
            echo "No release directories found under release/"
            exit 1
          fi
          mapfile -t gds_files < <(ls "$latest_dir"/*.gds 2>/dev/null || true)
          if [ "${#gds_files[@]}" -ne 1 ]; then
            echo "Expected exactly one .gds in $latest_dir, found ${#gds_files[@]}"
            printf '%s\n' "${gds_files[@]}"
            exit 1
          fi
          echo "gds_path=${gds_files[0]}" >> "$GITHUB_OUTPUT"

      - name: Run DRC
        run: |
          set -euo pipefail
          curl -L -o /tmp/run_drc.py https://raw.githubusercontent.com/IHP-GmbH/IHP-Open-PDK/dev/ihp-sg13g2/libs.tech/klayout/tech/drc/run_drc.py
          python /tmp/run_drc.py --path "${{ steps.gds.outputs.gds_path }}"
